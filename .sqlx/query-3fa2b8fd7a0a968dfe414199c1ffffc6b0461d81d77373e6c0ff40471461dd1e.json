{
  "db_name": "PostgreSQL",
  "query": "WITH\n  input_feeds AS (\n    SELECT\n      *,\n      $5::INT AS refresh_interval_min\n    FROM\n      unnest($2::TEXT[], $3::TEXT[], $4::TEXT[]) AS t (source_url, link, title)\n  ),\n  input_subscriptions AS (\n    SELECT\n      *,\n      $1::UUID AS user_id\n    FROM\n      unnest($2::TEXT[], $4::TEXT[]) AS t (source_url, title)\n  ),\n  input_tags AS (\n    SELECT\n      *,\n      $1::UUID AS user_id\n    FROM\n      unnest($6::TEXT[]) AS t (title)\n  ),\n  input_relationships AS (\n    SELECT\n      *\n    FROM\n      unnest($7::TEXT[], $8::TEXT[]) AS t (feed_source_url, tag_title)\n  ),\n  f AS (\n    INSERT INTO\n      feeds (source_url, link, title, refresh_interval_min)\n    SELECT\n      source_url,\n      link,\n      title,\n      refresh_interval_min\n    FROM\n      input_feeds\n    ON CONFLICT (source_url) DO UPDATE\n    SET\n      link = EXCLUDED.link,\n      title = EXCLUDED.title\n    RETURNING\n      id,\n      source_url\n  ),\n  s AS (\n    INSERT INTO\n      subscriptions (title, feed_id, user_id)\n    SELECT\n      s.title,\n      f.id,\n      s.user_id\n    FROM\n      input_subscriptions s\n      JOIN f ON f.source_url = s.source_url\n    ON CONFLICT (user_id, feed_id) DO UPDATE\n    SET\n      title = EXCLUDED.title\n    RETURNING\n      id,\n      feed_id\n  ),\n  fe AS (\n    SELECT\n      fe.id,\n      fe.feed_id\n    FROM\n      feed_entries fe\n      JOIN f ON f.id = fe.feed_id\n  ),\n  upserted_tags AS (\n    INSERT INTO\n      tags (title, user_id)\n    SELECT\n      title,\n      user_id\n    FROM\n      input_tags\n    ON CONFLICT (user_id, title) DO NOTHING\n  ),\n  new_tags AS (\n    SELECT\n      id,\n      title\n    FROM\n      tags\n    WHERE\n      title = ANY (\n        SELECT\n          title\n        FROM\n          input_tags\n      )\n  )\nINSERT INTO\n  subscription_tags (subscription_id, tag_id)\nSELECT\n  s.id,\n  t.id\nFROM\n  input_relationships i\n  JOIN f ON f.source_url = i.feed_source_url\n  JOIN s ON s.feed_id = f.id\n  JOIN new_tags t ON t.title = i.tag_title\nON CONFLICT (subscription_id, tag_id) DO NOTHING\n",
  "describe": {
    "columns": [],
    "parameters": {
      "Left": [
        "Uuid",
        "TextArray",
        "TextArray",
        "TextArray",
        "Int4",
        "TextArray",
        "TextArray",
        "TextArray"
      ]
    },
    "nullable": []
  },
  "hash": "3fa2b8fd7a0a968dfe414199c1ffffc6b0461d81d77373e6c0ff40471461dd1e"
}
